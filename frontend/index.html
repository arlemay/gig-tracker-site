<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bali Gigs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    #map { height: 60vh; }
  </style>

  <!-- Define API helper to use the Nginx reverse proxy -->
  <script>
    const API = (path) => `/api${path}`;
  </script>
</head>
<body class="bg-white text-slate-800">
  <header class="p-4 border-b border-slate-200">
    <div class="max-w-5xl mx-auto">
      <h1 class="text-2xl font-bold">Bali Gigs</h1>
      <p class="text-slate-500">Local bands • Venues • Events</p>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-4 space-y-4">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <nav class="inline-flex rounded-xl overflow-hidden border border-slate-200">
        <button data-page="events" class="tab px-4 py-2 bg-slate-900 text-white">Events</button>
        <button data-page="bands" class="tab px-4 py-2">Bands</button>
        <button data-page="venues" class="tab px-4 py-2">Venues (Map)</button>
      </nav>
      <div class="flex gap-2 items-center">
        <input id="search" type="search" placeholder="Search…" class="w-64 px-3 py-2 rounded-lg border border-slate-300" />
        <label class="flex items-center gap-2 text-sm text-slate-600">
          <input id="upcomingOnly" type="checkbox" class="rounded" checked>
          Upcoming only
        </label>
      </div>
    </div>

    <section id="page-events" class="page space-y-3"></section>

    <section id="page-bands" class="page hidden">
      <div id="bands" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </section>

    <section id="page-venues" class="page hidden space-y-3">
      <div id="map" class="rounded-xl border border-slate-200 shadow-sm"></div>
      <div id="venues" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  <script>
    // --- State ---
    let allBands = [], allVenues = [], allEvents = [];
    let map, markersLayer, mapReady = false;

    const $ = (sel) => document.querySelector(sel);
    const fmtDT = (s) => new Date(s).toLocaleString();
    const includes = (t, q) => (t || '').toLowerCase().includes(q);

    // --- Tabs ---
    const tabs = document.querySelectorAll('.tab');
    const pages = {
      events: $('#page-events'),
      bands: $('#page-bands'),
      venues: $('#page-venues'),
    };
    tabs.forEach(btn => btn.addEventListener('click', () => setPage(btn.dataset.page)));

    function setPage(name) {
      tabs.forEach(b => {
        b.classList.remove('bg-slate-900', 'text-white');
        if (b.dataset.page === name) b.classList.add('bg-slate-900', 'text-white');
      });
      Object.entries(pages).forEach(([k, el]) => el.classList.toggle('hidden', k !== name));
      if (name === 'venues' && !mapReady) initMap();
      render();
    }

    // --- Renderers ---
    function render() {
      const q = ($('#search').value || '').trim().toLowerCase();
      const upcomingOnly = $('#upcomingOnly').checked;

      // Events
      let ev = [...allEvents];
      if (upcomingOnly) {
        const now = Date.now();
        ev = ev.filter(e => new Date(e.starts_at).getTime() >= now);
      }
      if (q) {
        ev = ev.filter(e =>
          includes(e.title, q) ||
          includes(e.venue?.name, q) ||
          (e.bands || []).some(b => includes(b.name, q))
        );
      }
      ev.sort((a, b) => new Date(a.starts_at) - new Date(b.starts_at));
      $('#page-events').innerHTML = ev.map(eventCard).join('') || emptyState('No events match.');

      // Bands
      let bands = [...allBands];
      if (q) bands = bands.filter(b => includes(b.name, q) || includes(b.genre, q) || includes(b.city, q));
      $('#bands').innerHTML = bands.map(bandCard).join('') || emptyState('No bands match.');

      // Venues
      let venues = [...allVenues];
      if (q) venues = venues.filter(v => includes(v.name, q) || includes(v.address, q) || includes(v.district, q));
      $('#venues').innerHTML = venues.map(venueCard).join('') || emptyState('No venues match.');
      if (mapReady) addMarkers(venues);
    }

    function emptyState(text) {
      return `<div class="p-6 text-center text-slate-500 border border-dashed rounded-xl">${text}</div>`;
    }

    function eventCard(e) {
      const bands = e.bands?.map(b => b.name).join(', ');
      return `
        <article class="border rounded-xl p-4 shadow-sm border-slate-200">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="font-semibold text-lg">${e.title}</h3>
              <div class="text-sm text-slate-600">${fmtDT(e.starts_at)} • <button class="underline" onclick="focusVenue(${e.venue.id})">${e.venue.name}</button></div>
              ${bands ? `<div class="text-sm mt-1"><span class="font-medium">Bands:</span> ${bands}</div>` : ''}
              ${e.price ? `<div class="text-sm mt-1">${e.price}</div>` : ''}
              ${e.url ? `<div class="text-sm mt-1"><a class="text-blue-600 underline" href="${e.url}" target="_blank" rel="noopener">More info</a></div>` : ''}
            </div>
          </div>
        </article>`;
    }

    function bandCard(b) {
      return `
        <article class="border rounded-xl p-4 shadow-sm border-slate-200">
          <h3 class="font-semibold">${b.name}</h3>
          <div class="text-sm text-slate-600">${[b.genre, b.city].filter(Boolean).join(' • ')}</div>
          ${b.instagram ? `<div class="text-sm mt-1">IG: <a class="underline" href="https://instagram.com/${b.instagram}" target="_blank" rel="noopener">@${b.instagram}</a></div>` : ''}
          ${b.youtube ? `<div class="text-sm">YouTube: <a class="underline" href="${b.youtube}" target="_blank" rel="noopener">link</a></div>` : ''}
          ${b.description ? `<p class="text-sm mt-2">${b.description}</p>` : ''}
        </article>`;
    }

    function venueCard(v) {
      return `
        <article class="border rounded-xl p-4 shadow-sm border-slate-200">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="font-semibold">${v.name}</h3>
              ${v.address ? `<div class="text-sm text-slate-600">${v.address}</div>` : ''}
              ${v.district ? `<div class="text-sm text-slate-600">${v.district}</div>` : ''}
              ${v.instagram ? `<div class="text-sm">IG: <a class="underline" href="https://instagram.com/${v.instagram}" target="_blank" rel="noopener">@${v.instagram}</a></div>` : ''}
              ${v.website ? `<div class="text-sm"><a class="underline" href="${v.website}" target="_blank" rel="noopener">Website</a></div>` : ''}
            </div>
            <button class="px-3 py-1 text-sm rounded-lg border" onclick="focusLatLon(${v.lat}, ${v.lon})">View on map</button>
          </div>
        </article>`;
    }

    // --- Map ---
    function initMap() {
      mapReady = true;
      map = L.map('map').setView([-8.4095, 115.1889], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      addMarkers(allVenues);
    }

    function addMarkers(venues) {
      markersLayer.clearLayers();
      venues.forEach(v => {
        const m = L.marker([v.lat, v.lon]).addTo(markersLayer);
        m.bindPopup(`<strong>${v.name}</strong><br/>${v.address || ''}`);
      });
    }

    window.focusLatLon = (lat, lon) => {
      setPage('venues');
      map.setView([lat, lon], 13);
    };

    window.focusVenue = (id) => {
      const v = allVenues.find(x => x.id === id);
      if (v) window.focusLatLon(v.lat, v.lon);
    };

    // --- Data ---
    async function fetchJSON(path) {
      const r = await fetch(API(path));
      if (!r.ok) throw new Error(`Failed ${path}`);
      return await r.json();
    }

    async function boot() {
      [allBands, allVenues, allEvents] = await Promise.all([
        fetchJSON('/bands'),
        fetchJSON('/venues'),
        fetchJSON('/events')
      ]);
      render();
    }

    $('#search').addEventListener('input', render);
    $('#upcomingOnly').addEventListener('change', render);

    setPage('events');
    boot().catch(err => {
      console.error(err);
      pages.events.innerHTML = `<div class="p-6 text-center text-red-600 border border-red-200 rounded-xl">Failed to load API data. Check backend at /api/.</div>`;
    });
  </script>
</body>
</html>
